<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propeller - Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        .propeller-font {
            font-family: 'Orbitron', monospace;
        }
        
        .sidebar-transition { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .message-fade-in { 
            animation: fadeInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }
        
        .chat-bubble { 
            max-width: 85%; 
            word-wrap: break-word;
        }
        
        .scrollbar-hide { 
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar { 
            display: none;
        }
        
        .chat-item {
            transition: all 0.2s ease;
        }
        
        .chat-item:hover {
            background: rgba(16, 185, 129, 0.1);
            transform: translateX(4px);
        }
        
        .chat-item.active {
            background: rgba(16, 185, 129, 0.2);
            border-left: 3px solid var(--accent-primary);
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .typing-dot {
            animation: pulse-dot 1.4s ease-in-out infinite;
        }
        
        .glass-effect {
            background: rgba(42, 42, 44, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .input-glow:focus-within {
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
        }
        
        .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        /* Futuristic Grid Background */
        .grid-background {
            background-color: #0a0e1a;
            background-image: 
                linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-position: center center;
        }
        
        .grid-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(10, 14, 26, 0.8) 100%);
            pointer-events: none;
        }
        
        /* Centered Welcome Screen with Glow */
        .welcome-centered {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            position: relative;
            z-index: 1;
        }
        
        /* Modern Input Box with Neon Glow */
        .neon-input-container {
            width: 100%;
            max-width: 700px;
            position: relative;
            margin: 0 auto;
        }
        
        /* Propeller Label Above Input */
        .propeller-label {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeIn 0.6s ease-out;
        }
        
        .propeller-label span {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px rgba(16, 185, 129, 0.4);
            letter-spacing: 3px;
        }
        
        .propeller-label-bottom {
            text-align: left;
            margin-bottom: 14px;
            padding-left: 4px;
        }
        
        .propeller-label-bottom span {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #10b981;
            letter-spacing: 1.5px;
            opacity: 0.95;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .neon-input-box {
            background: rgba(20, 25, 35, 0.95);
            border: 2px solid rgba(16, 185, 129, 0.5);
            border-radius: 20px;
            padding: 20px 24px;
            box-shadow: 
                0 0 20px rgba(16, 185, 129, 0.3),
                0 0 40px rgba(16, 185, 129, 0.1),
                inset 0 0 20px rgba(16, 185, 129, 0.05);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .neon-input-box:focus-within {
            border-color: rgba(16, 185, 129, 0.8);
            box-shadow: 
                0 0 30px rgba(16, 185, 129, 0.5),
                0 0 60px rgba(16, 185, 129, 0.2),
                inset 0 0 30px rgba(16, 185, 129, 0.1);
        }
        
        .neon-input-box textarea {
            background: transparent;
            border: none;
            outline: none;
            color: #e5e7eb;
            font-size: 16px;
            resize: none;
            width: 100%;
            font-family: 'Inter', sans-serif;
            text-align: left;
            line-height: 1.5;
            padding: 12px 16px;
            min-height: 44px;
            max-height: 200px;
            overflow-y: hidden;
            transition: height 0.1s ease;
        }
        
        .neon-input-box textarea::placeholder {
            color: #6b7280;
            font-size: 16px;
            text-align: left;
            line-height: 1.5;
            opacity: 0.7;
        }
        
        @keyframes placeholderPulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Action Buttons Below Input */
        .action-buttons-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }
        
        .action-btn {
            background: rgba(20, 25, 35, 0.8);
            border: 1.5px solid rgba(16, 185, 129, 0.4);
            border-radius: 16px;
            padding: 14px 32px;
            color: #d1d5db;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.7);
            box-shadow: 
                0 0 24px rgba(16, 185, 129, 0.4),
                0 8px 20px rgba(0, 0, 0, 0.4);
            transform: translateY(-3px);
            color: #10b981;
        }
        
        .action-btn:active {
            transform: translateY(-1px);
        }
        
        .action-btn svg {
            width: 18px;
            height: 18px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover svg {
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.6));
            transform: scale(1.15);
        }
        
        /* Responsive action buttons */
        @media (max-width: 640px) {
            .action-btn {
                padding: 12px 24px;
                font-size: 13px;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .action-btn {
                padding: 10px 20px;
                font-size: 12px;
            }
            
            .action-btn svg {
                width: 16px;
                height: 16px;
            }
        }
        
        /* Send Button with Glow */
        .send-btn-glow {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
        }
        
        .send-btn-glow:hover {
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.6);
            transform: scale(1.05);
        }
        
        .send-btn-glow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Input Controls */
        .input-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .input-icon-btn {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .input-icon-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .chat-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            z-index: 50;
        }
        
        /* Sidebar avatar dropdown scrollbar */
        #sidebarAvatarDropdown {
            scrollbar-width: thin;
            scrollbar-color: rgba(99, 102, 241, 0.5) rgba(255, 255, 255, 0.05);
        }
        
        #sidebarAvatarDropdown::-webkit-scrollbar {
            width: 6px;
        }
        
        #sidebarAvatarDropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        #sidebarAvatarDropdown::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 10px;
        }
        
        #sidebarAvatarDropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.7);
        }
        
        /* Sidebar minimized state */
        #sidebar.minimized {
            width: 80px !important;
        }
        
        #sidebar.minimized .sidebar-text,
        #sidebar.minimized .chat-history-section,
        #sidebar.minimized #userName,
        #sidebar.minimized .user-plan,
        #sidebar.minimized #sidebarAvatarBtn,
        #sidebar.minimized .plan-card,
        #sidebar.minimized .bottom-actions {
            display: none !important;
        }
        
        /* Sidebar Redesign - Modern Professional Look */
        #sidebar {
            background: #1a1a1c !important;
            border-right: 1px solid rgba(16, 185, 129, 0.1) !important;
        }
        
        /* New header layout */
        .sidebar-header-new {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .app-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .app-branding {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .app-logo-box {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .app-name {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-btn {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #9ca3af;
        }
        
        .header-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        /* New Chat Row (Button + Search) */
        .new-chat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
        }
        
        /* New Chat Button - Prominent */
        .new-chat-btn-large {
            flex: 1;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, rgba(5, 150, 105, 0.08) 100%);
            border: 1.5px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #10b981;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
        }
        
        .new-chat-btn-large:hover {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.15) 100%);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.35);
            transform: translateY(-2px);
        }
        
        .new-chat-btn-large:active {
            transform: translateY(0);
        }
        
        .new-chat-btn-large svg {
            transition: all 0.3s ease;
        }
        
        .new-chat-btn-large:hover svg {
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.6));
            transform: rotate(90deg) scale(1.1);
        }
        
        /* Search Button */
        .search-btn {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.05);
            border: 1.5px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #10b981;
        }
        
        .search-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
        }
        
        /* Search Box */
        .search-box {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 10px;
            padding: 8px 12px;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #e5e7eb;
            font-size: 13px;
            padding: 4px;
        }
        
        .search-input::placeholder {
            color: #6b7280;
        }
        
        .search-close-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #9ca3af;
            transition: all 0.2s ease;
        }
        
        .search-close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        /* Dropdown Sections */
        .dropdown-section {
            margin: 12px 0 0 0;
            padding: 0 16px;
        }
        
        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }
        
        .dropdown-header:hover {
            background: rgba(16, 185, 129, 0.08);
            border-color: rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.15);
            transform: translateX(2px);
        }
        
        .dropdown-header:active {
            transform: scale(0.98);
        }
        
        .dropdown-title {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
        }
        
        .dropdown-arrow {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            color: #6b7280;
            filter: drop-shadow(0 0 4px rgba(16, 185, 129, 0));
        }
        
        .dropdown-header:hover .dropdown-arrow {
            color: #10b981;
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.4));
        }
        
        .dropdown-arrow.expanded {
            transform: rotate(90deg);
        }
        
        .dropdown-actions {
            display: flex;
            gap: 4px;
        }
        
        .dropdown-add-btn {
            width: 24px;
            height: 24px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #10b981;
        }
        
        .dropdown-add-btn:hover {
            background: rgba(16, 185, 129, 0.2);
            transform: scale(1.1);
        }
        
        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            opacity: 0;
        }
        
        .dropdown-content.expanded {
            max-height: 400px;
            opacity: 1;
            overflow-y: auto;
            padding: 8px 4px;
        }
        
        .dropdown-content::-webkit-scrollbar {
            width: 4px;
        }
        
        .dropdown-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .dropdown-content::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.3);
            border-radius: 10px;
        }
        
        .dropdown-content::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.5);
        }
        
        /* Avatar Items in Dropdown */
        .avatar-item-new {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: 4px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            opacity: 0;
            animation: fadeInSlide 0.3s ease forwards;
        }
        
        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .avatar-item-new:nth-child(1) { animation-delay: 0.05s; }
        .avatar-item-new:nth-child(2) { animation-delay: 0.1s; }
        .avatar-item-new:nth-child(3) { animation-delay: 0.15s; }
        .avatar-item-new:nth-child(4) { animation-delay: 0.2s; }
        .avatar-item-new:nth-child(5) { animation-delay: 0.25s; }
        
        .avatar-item-new:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            box-shadow: 0 0 16px rgba(16, 185, 129, 0.2);
            transform: translateX(4px);
        }
        
        .avatar-icon-new {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }
        
        .avatar-item-new:hover .avatar-icon-new {
            border-color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }
        
        .avatar-info-new {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .avatar-name-new {
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
        }
        
        .avatar-status-new {
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .avatar-status-new.active {
            color: #10b981;
        }
        
        .avatar-status-new.pending {
            color: #fbbf24;
        }
        
        .dropdown-item {
            padding: 10px 12px 10px 32px;
            color: #9ca3af;
            font-size: 13px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            margin: 2px 0;
        }
        
        .dropdown-item:hover {
            background: rgba(16, 185, 129, 0.05);
            color: #10b981;
            padding-left: 36px;
        }
        
        /* Recent Chats Section */
        .recent-chats-section {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
            margin-top: 8px;
        }
        
        .recent-chats-section::-webkit-scrollbar {
            width: 4px;
        }
        
        .recent-chats-section::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .recent-chats-section::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.2);
            border-radius: 10px;
        }
        
        .chat-date-divider {
            color: #6b7280;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 16px 0 8px 0;
            padding: 0 4px;
        }
        
        .recent-chat-item {
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 4px 0;
            border-left: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recent-chat-item:hover {
            background: rgba(16, 185, 129, 0.08);
            border-left-color: #10b981;
            transform: translateX(4px);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.1);
        }
        
        .recent-chat-item.active {
            background: rgba(16, 185, 129, 0.12);
            border-left-color: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.15);
        }
        
        .recent-chat-title {
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* LLM-Style Chat History Container */
        .chat-history-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 4px;
            padding: 0;
        }
        
        .chat-history-header {
            padding: 8px 16px;
            margin-bottom: 4px;
        }
        
        .chat-history-title {
            color: #6b7280;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .chat-history-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0 8px;
        }
        
        .chat-history-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-history-scroll::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-history-scroll::-webkit-scrollbar-thumb {
            background: rgba(16, 185, 129, 0.2);
            border-radius: 10px;
        }
        
        .chat-history-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(16, 185, 129, 0.3);
        }
        
        /* LLM-Style Chat Item */
        .llm-chat-item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            margin: 2px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
        }
        
        .llm-chat-item:hover {
            background: rgba(16, 185, 129, 0.08);
        }
        
        .llm-chat-item.active {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.08) 100%);
            border-left: 3px solid #10b981;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }
        
        .llm-chat-item.search-match {
            background: rgba(16, 185, 129, 0.15);
            border-left: 2px solid #10b981;
        }
        
        .llm-chat-icon {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            color: #9ca3af;
        }
        
        .llm-chat-title {
            flex: 1;
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        
        .llm-chat-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .llm-chat-item:hover .llm-chat-actions {
            opacity: 1;
        }
        
        .llm-chat-action-btn {
            padding: 4px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .llm-chat-action-btn:hover {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        
        .llm-chat-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }
        
        .llm-chat-action-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* Account Section */
        .account-section {
            position: relative;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .account-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.02);
        }
        
        .account-trigger:hover {
            background: rgba(16, 185, 129, 0.08);
        }
        
        .account-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(16, 185, 129, 0.3);
        }
        
        .account-info {
            flex: 1;
            min-width: 0;
        }
        
        .account-name {
            color: #e5e7eb;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .account-email {
            color: #9ca3af;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .account-dropdown-arrow {
            width: 16px;
            height: 16px;
            color: #9ca3af;
            transition: transform 0.2s ease;
        }
        
        .account-trigger:hover .account-dropdown-arrow {
            color: #10b981;
        }
        
        /* Account Dropdown Menu */
        .account-dropdown {
            position: absolute;
            bottom: 100%;
            left: 12px;
            right: 12px;
            margin-bottom: 8px;
            background: rgba(26, 26, 28, 0.98);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            z-index: 1000;
            backdrop-filter: blur(12px);
        }
        
        .account-dropdown.hidden {
            display: none;
        }
        
        .account-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #e5e7eb;
            font-size: 13px;
            text-decoration: none;
            background: transparent;
            border: none;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .account-dropdown-item:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .account-dropdown-item svg {
            flex-shrink: 0;
        }
        
        .account-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 4px 0;
        }
        
        /* Plan Card at Bottom */
        .plan-card {
            margin: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.04) 100%);
            border: 1.5px solid rgba(16, 185, 129, 0.25);
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.12);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .plan-card:hover {
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }
        
        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .plan-title {
            color: #10b981;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        
        .plan-message {
            color: #6ee7b7;
            font-size: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        
        .plan-progress {
            height: 4px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .plan-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            width: 100%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .plan-upgrade-text {
            color: #9ca3af;
            font-size: 11px;
            margin-bottom: 10px;
        }
        
        .upgrade-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }
        
        .upgrade-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }
        
        .upgrade-btn:active {
            transform: translateY(0);
        }
        
        /* Bottom Actions */
        .bottom-actions {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .bottom-action-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #9ca3af;
        }
        
        .bottom-action-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
            box-shadow: 0 0 16px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }
        
        .bottom-action-btn:active {
            transform: translateY(0);
        }
        
        .bottom-action-btn svg {
            width: 18px;
            height: 18px;
            transition: all 0.3s ease;
        }
        
        .bottom-action-btn:hover svg {
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.6));
            transform: scale(1.1);
        }
        
        /* Remove flex-1 from chat history when minimized so user info goes to bottom */
        #sidebar.minimized .chat-history-section {
            flex: 0 !important;
            height: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }
        
        /* Show spacer when minimized to push profile to bottom */
        #sidebar.minimized .spacer-minimized {
            display: block !important;
            flex: 1 !important;
        }
        
        #sidebar.minimized #newChatBtn span {
            display: none !important;
        }
        
        #sidebar.minimized #newChatBtn {
            padding: 12px !important;
            justify-content: center !important;
        }
        
        #sidebar.minimized #settingsBtn {
            justify-content: center !important;
            padding: 12px !important;
        }
        
        #sidebar.minimized #settingsBtn > div:first-child {
            justify-content: center !important;
            flex: 0 !important;
        }
        
        #sidebar.minimized .logo-container {
            justify-content: center !important;
        }
        
        #sidebar.minimized .logo-container > div {
            justify-content: center !important;
        }
        
        #sidebar.minimized #settingsDropdown {
            left: 85px !important;
            bottom: 4px !important;
            right: auto !important;
            width: 250px !important;
            min-width: 250px !important;
        }
        
        /* Sidebar avatar dropdown positioning when minimized */
        #sidebar.minimized #sidebarAvatarDropdown {
            left: 85px !important;
            top: 0 !important;
            right: auto !important;
            width: 300px !important;
            min-width: 300px !important;
        }
        
        #sidebar.minimized #sidebarAvatarBtn {
            justify-content: center !important;
            padding: 12px !important;
        }
        
        #sidebar.minimized #sidebarAvatarBtn .sidebar-text {
            display: none !important;
        }
        
        /* Logo hover effect - show minimize button, hide logo */
        .logo-wrapper {
            position: relative;
            width: 44px;
            height: 44px;
        }
        
        #sidebarLogo {
            transition: opacity 0.2s ease;
        }
        
        .minimize-btn {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-wrapper:hover #sidebarLogo {
            opacity: 0;
        }
        
        .logo-wrapper:hover .minimize-btn {
            opacity: 1;
        }
        
        /* Light Mode Styles - Modern Clean Design */
        body.light-mode {
            background-color: #f7f8fa !important;
        }
        
        /* Sidebar - Soft gradient with subtle border */
        body.light-mode #sidebar {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            box-shadow: 1px 0 3px rgba(0, 0, 0, 0.03) !important;
        }
        
        /* Text colors - Strong hierarchy */
        body.light-mode .text-white {
            color: #111827 !important;
            font-weight: 500;
        }
        
        body.light-mode .text-gray-400 {
            color: #6b7280 !important;
        }
        
        body.light-mode .text-gray-500 {
            color: #9ca3af !important;
        }
        
        body.light-mode .text-gray-600 {
            color: #4b5563 !important;
        }
        
        /* Glass effect - Clean cards with shadows */
        body.light-mode .glass-effect {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 3px 0 rgba(0, 0, 0, 0.04) !important;
            border-radius: 12px !important;
        }
        
        /* Borders - Subtle and clean */
        body.light-mode .border-b,
        body.light-mode .border-t,
        body.light-mode .border-r {
            border-color: #e5e7eb !important;
        }
        
        /* Hover states - Subtle interactions */
        body.light-mode .bg-gray-800\/50 {
            background-color: #f3f4f6 !important;
        }
        
        body.light-mode .chat-item {
            border-radius: 10px !important;
            margin: 2px 0 !important;
            transition: all 0.2s ease !important;
        }
        
        body.light-mode .chat-item:hover {
            background: #f3f4f6 !important;
            transform: translateX(2px) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
        }
        
            body.light-mode .chat-item.active {
            background: #eef2ff !important;
            border-left: 3px solid #6366f1 !important;
            box-shadow: 0 1px 3px rgba(99, 102, 241, 0.1) !important;
        }        body.light-mode .hover\:text-white:hover {
            color: #111827 !important;
        }
        
        body.light-mode .hover\:bg-gray-800\/50:hover {
            background-color: #f3f4f6 !important;
            border-radius: 10px !important;
        }
        
        /* Main content area - Soft background */
        body.light-mode #messagesContainer,
        body.light-mode .flex-1 {
            background-color: #f7f8fa !important;
        }
        
        /* Input area - Clean white with shadow */
        body.light-mode textarea {
            color: #111827 !important;
            background: #ffffff !important;
            font-weight: 400;
        }
        
        body.light-mode textarea::placeholder {
            color: #9ca3af !important;
        }
        
        body.light-mode .input-glow {
            background: #ffffff !important;
            border-color: #d1d5db !important;
            border-radius: 16px !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04) !important;
        }
        
        body.light-mode .input-glow:focus-within {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08), 0 1px 3px rgba(0, 0, 0, 0.06) !important;
        }
        
        /* Buttons - Rounded with better hover */
        body.light-mode button {
            border-radius: 10px !important;
        }
        
        body.light-mode #newChatBtn {
            background: #ffffff !important;
            color: #111827 !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        body.light-mode #newChatBtn:hover {
            background: #f3f4f6 !important;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        body.light-mode #sendBtn {
            background: #ffffff !important;
            color: #111827 !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }
        
        body.light-mode #sendBtn:hover {
            background: #f3f4f6 !important;
        }
        
        /* Dropdowns - Clean with proper shadows */
        body.light-mode #settingsDropdown {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04) !important;
            border-radius: 12px !important;
        }
        
        body.light-mode #settingsDropdown a,
        body.light-mode #settingsDropdown button {
            border-radius: 8px !important;
            margin: 4px 8px !important;
            color: #374151 !important;
        }
        
        body.light-mode #settingsDropdown a:hover,
        body.light-mode #settingsDropdown button:hover {
            color: #111827 !important;
        }
        
        body.light-mode #settingsDropdown button:hover {
            color: #dc2626 !important;
        }
        
        body.light-mode #settingsDropdown .border-b {
            border-color: #f3f4f6 !important;
        }
        
        body.light-mode [id^="chatMenu"] {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04) !important;
            border-radius: 12px !important;
        }
        
        body.light-mode [id^="chatMenu"] button {
            margin: 4px 8px !important;
            border-radius: 8px !important;
        }
        
        body.light-mode [id^="chatMenu"] .border-b,
        body.light-mode [id^="chatMenu"] .border-t {
            border-color: #f3f4f6 !important;
        }
        
        /* Sidebar avatar dropdown - Light mode */
        body.light-mode #sidebarAvatarDropdown {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08), 0 4px 10px rgba(0, 0, 0, 0.04) !important;
        }
        
        body.light-mode #sidebarAvatarDropdown a,
        body.light-mode #sidebarAvatarDropdown button {
            color: #374151 !important;
        }
        
        body.light-mode #sidebarAvatarDropdown a:hover,
        body.light-mode #sidebarAvatarDropdown button:hover {
            color: #111827 !important;
            background-color: #f3f4f6 !important;
        }
        
        body.light-mode #sidebarAvatarDropdown .border-t {
            border-color: #e5e7eb !important;
        }
        
        /* Message bubbles - Better contrast */
        body.light-mode .chat-bubble {
            color: #111827 !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
        }
        
        /* User info section - Clean spacing */
        body.light-mode #userName {
            color: #111827 !important;
            font-weight: 600;
        }
        
        body.light-mode #userInitial {
            color: #ffffff !important;
        }
        
        body.light-mode #settingsBtn {
            border-radius: 12px !important;
        }
        
        body.light-mode #settingsBtn:hover {
            background-color: #f3f4f6 !important;
        }
        
        /* Welcome screen - Modern cards */
        body.light-mode .suggestion-card {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            border-radius: 24px !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04) !important;
        }
        
        body.light-mode .suggestion-card:hover {
            background: #ffffff !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04) !important;
            transform: translateY(-2px) !important;
        }
        
        body.light-mode .suggestion-card span {
            color: #111827 !important;
            font-weight: 500;
        }
        
        /* Top bar - Clean header */
        body.light-mode .border-b.px-6 {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02) !important;
        }
        
        /* Action buttons - Rounded and clean */
        body.light-mode #fileUploadBtn,
        body.light-mode .w-10.h-10 {
            border-radius: 10px !important;
        }
        
        body.light-mode #fileUploadBtn:hover,
        body.light-mode .w-10.h-10:hover {
            background-color: #f3f4f6 !important;
        }
        
        /* Profile section background */
        body.light-mode .p-4.border-t {
            background: #ffffff !important;
        }
        
        /* Footer/Input section - CRITICAL FIX */
        body.light-mode .footer-section {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
        }
        
        body.light-mode .footer-section p {
            color: #9ca3af !important;
        }
        
        /* Action button icons in light mode */
        body.light-mode .footer-section svg {
            color: #6b7280 !important;
        }
        
        body.light-mode .footer-section button:hover svg {
            color: #6366f1 !important;
        }
        
        /* Sidebar Header - Light mode override for inline styles */
        body.light-mode .p-5.border-b {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
        }
        
        /* User Info Section at Bottom - Light mode */
        body.light-mode .p-4.border-t {
            background: #ffffff !important;
            border-color: #e5e7eb !important;
        }
        
        /* ====================================
           MOBILE RESPONSIVE - Hide Sidebar
           ==================================== */
        
        /* Hide sidebar on mobile devices (for screenshots and mobile users) */
        @media (max-width: 768px) {
            #sidebar {
                display: none !important;
            }
            
            /* Make main chat area full width when sidebar is hidden */
            .flex-1 {
                margin-left: 0 !important;
            }
            
            /* Adjust the main container to use full width */
            body > div {
                padding-left: 0 !important;
            }
        }
        
        /* Alternative: For very specific mobile screenshot dimensions */
        @media (max-width: 414px) {
            #sidebar {
                display: none !important;
            }
        }
        
        /* iPhone SE and similar small devices */
        @media (max-width: 375px) {
            #sidebar {
                display: none !important;
            }
        }
    </style>
</head>
<body class="font-['Inter'] h-screen overflow-hidden" style="background-color: #1f1f21;">
    <div class="flex h-full">
        <!-- Redesigned Sidebar -->
        <div id="sidebar" class="sidebar-transition shadow-2xl border-r flex flex-col" style="width: 280px;">
            <!-- New Header Section -->
            <div class="sidebar-header-new">
                <!-- App Title Row -->
                <div class="app-title-row">
                    <div class="app-branding">
                        <div class="app-logo-box">
                            <img src="assets/images/logo.png" alt="AI" class="w-6 h-6 rounded object-cover">
                        </div>
                        <span class="app-name">Propeller</span>
                    </div>
                </div>
                
                <!-- New Chat Button with Search -->
                <div class="new-chat-row">
                    <button id="newChatBtn" class="new-chat-btn-large" title="Start a new conversation">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>New Chat</span>
                    </button>
                    <button class="search-btn" id="searchBtn" title="Search your chats">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Search Input (Hidden by default) -->
                <div id="searchBox" class="search-box" style="display: none;">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search chats...">
                    <button class="search-close-btn" id="closeSearchBtn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Avatars Dropdown Section -->
            <div class="dropdown-section">
                <div class="dropdown-header" id="avatarsDropdownHeader">
                    <div class="dropdown-title">
                        <svg class="w-4 h-4 dropdown-arrow" id="avatarsArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>Avatars</span>
                    </div>
                    <div class="dropdown-actions">
                        <button class="dropdown-add-btn" title="Add Avatar" onclick="event.stopPropagation(); window.location.href='/avatars'">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="dropdown-content" id="avatarsDropdownContent">
                    <div id="avatarsListSidebar"></div>
                </div>
            </div>
            
            <!-- Chat History Section (LLM Style) -->
            <div class="chat-history-container">
                <div class="chat-history-header">
                    <span class="chat-history-title">Recent</span>
                </div>
                <div class="chat-history-scroll" id="chatHistoryList">
                    <!-- Chat items will be dynamically added here -->
                </div>
                
                <div id="noChatHistory" class="text-center py-12 px-4" style="display: none;">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <p class="text-gray-500 text-xs">No chats yet</p>
                </div>
            </div>
            
            <!-- Account Section (Bottom) -->
            <div class="account-section">
                <div class="account-trigger" id="accountTrigger">
                    <img id="userProfilePic" src="" alt="Profile" class="account-avatar">
                    <div class="account-info">
                        <div class="account-name" id="userName">Yajat</div>
                        <div class="account-email" id="userEmail">yajat@gmail.com</div>
                    </div>
                    <svg class="account-dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                
                <!-- Account Dropdown Menu -->
                <div class="account-dropdown hidden" id="accountDropdown">
                    <a href="/settings" class="account-dropdown-item">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <span>View Profile</span>
                    </a>
                    <a href="/settings" class="account-dropdown-item">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span>Manage Account</span>
                    </a>
                    <div class="account-dropdown-divider"></div>
                    <button class="account-dropdown-item" id="logoutBtnAccount">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                        </svg>
                        <span>Log Out</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col grid-background" style="position: relative;">
            <!-- Top Bar -->
            <div class="border-b px-4 py-2 flex items-center justify-between" style="border-color: rgba(16, 185, 129, 0.2); background: rgba(10, 14, 26, 0.8); backdrop-filter: blur(12px);">
                <div class="flex items-center space-x-3">
                    <button id="mobileSidebarToggle" class="text-gray-400 hover:text-white transition-colors lg:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div class="relative">
                        <button id="avatarSwitcherMain" class="flex items-center space-x-2 hover:bg-gray-800/50 px-2 py-1 rounded-lg transition-all">
                            <div>
                                <h2 class="text-white font-semibold text-sm text-left">Propeller AI</h2>
                                <p class="text-xs text-gray-400">General AI Assistant</p>
                            </div>
                            <svg class="w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="avatarSwitcherDropdownMain" class="hidden absolute top-full left-0 mt-2 w-72 rounded-xl shadow-2xl border overflow-hidden" style="background: rgba(26, 26, 28, 0.98); border-color: #3a3a3c; backdrop-filter: blur(12px); z-index: 9999;">
                            <div class="p-3 border-b" style="border-color: #3a3a3c;">
                                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Switch AI Assistant</p>
                            </div>
                            <a href="/chat" class="flex items-center space-x-3 p-4 hover:bg-indigo-600/20 transition-colors border-b bg-indigo-600/10" style="border-color: #3a3a3c;">
                                <img src="assets/images/logo.png" alt="Propeller" class="w-10 h-10 rounded-xl">
                                <div class="flex-1">
                                    <div class="text-white font-semibold">Propeller AI</div>
                                    <div class="text-xs text-gray-400">General AI Assistant</div>
                                </div>
                            </a>
                            <div class="p-3 border-b" style="border-color: #3a3a3c;">
                                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Avatars</p>
                            </div>
                            <div id="avatarListMain"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2">
                    <button class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-gray-800/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Messages Container -->
            <div id="messagesContainer" class="hidden flex-1 overflow-y-auto scrollbar-hide" style="background: linear-gradient(135deg, #1a1a1c 0%, #1e1e20 100%); padding-top: 24px; padding-bottom: 24px;">
                <div id="messagesList" class="space-y-6 p-6 w-full max-w-4xl mx-auto">
                    <!-- Messages will be added here -->
                </div>
            </div>
            
            <!-- Welcome Screen with Centered Input -->
            <div id="welcomeScreen" class="flex-1 welcome-centered p-6">
                <div class="neon-input-container">
                    <!-- Propeller Label -->
                    <div class="propeller-label">
                        <span>Propeller</span>
                    </div>
                    
                    <!-- Main Input Box -->
                    <div class="neon-input-box">
                        <div class="flex items-center gap-3">
                            <button id="fileUploadBtn" class="input-icon-btn" title="Attach file">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </button>
                            <input type="file" id="fileInput" multiple style="display: none;">
                            
                            <textarea 
                                id="messageInput"
                                placeholder="Ask me anything..."
                                rows="1"
                                class="flex-1"
                            ></textarea>
                            
                            <div class="input-controls">
                                <button id="sendBtn" class="send-btn-glow" title="Send message">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-buttons-container">
                        <button class="action-btn" id="webSearchBtn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                            </svg>
                            <span>Web Search</span>
                        </button>
                        
                        <button class="action-btn" id="deepSearchBtn">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            <span>DeepThink</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Input Area (For When Messages Exist) -->
            <div id="bottomInputArea" class="hidden p-4 border-t" style="border-color: rgba(16, 185, 129, 0.2); background: rgba(10, 14, 26, 0.95); backdrop-filter: blur(12px);">
                <div class="max-w-4xl mx-auto">
                    <!-- Propeller Label -->
                    <div class="propeller-label-bottom">
                        <span>Propeller</span>
                    </div>
                    
                    <div class="neon-input-box">
                        <div class="flex items-center gap-3">
                            <button class="input-icon-btn" title="Attach file" onclick="document.getElementById('fileInput').click()">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </button>
                            
                            <textarea 
                                id="messageInputBottom"
                                placeholder="Ask me anything..."
                                rows="1"
                                class="flex-1"
                            ></textarea>
                            
                            <div class="input-controls">
                                <button id="sendBtnBottom" class="send-btn-glow" title="Send message">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toast notification system for debugging
        function showToast(message, type = 'info') {
            console.log(`TOAST [${type}]: ${message}`);
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'error' ? 'bg-red-600' : 
                type === 'success' ? 'bg-green-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                'bg-indigo-600'
            }`;
            toast.textContent = message;
            toast.style.animation = 'slideInRight 0.3s ease-out';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Theme Management - Must be first to avoid flash
        function applyTheme() {
            const savedTheme = localStorage.getItem('propellerTheme') || 'auto';
            let shouldBeLightMode = false;
            
            if (savedTheme === 'light') {
                shouldBeLightMode = true;
            } else if (savedTheme === 'dark') {
                shouldBeLightMode = false;
            } else {
                // Auto mode - detect system preference
                shouldBeLightMode = window.matchMedia('(prefers-color-scheme: light)').matches;
            }
            
            if (shouldBeLightMode) {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }
            
            // Update logos based on theme
            updateLogos(shouldBeLightMode);
        }
        
        // Function to update logos based on theme
        function updateLogos(isLightMode) {
            const logoPath = isLightMode ? 'assets/images/logoo.png' : 'assets/images/logo.png';
            const sidebarLogo = document.getElementById('sidebarLogo');
            const welcomeLogo = document.getElementById('welcomeLogo');
            
            if (sidebarLogo) sidebarLogo.src = logoPath;
            if (welcomeLogo) welcomeLogo.src = logoPath;
        }
        
        // Apply theme immediately
        applyTheme();
        
        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const savedTheme = localStorage.getItem('propellerTheme') || 'auto';
            if (savedTheme === 'auto') {
                applyTheme();
            }
        });
        
        // Listen for theme changes from settings page
        window.addEventListener('storage', (e) => {
            if (e.key === 'propellerTheme') {
                applyTheme();
            }
        });
    
        // Initialize user info from server
        async function initializeUser() {
            try {
                const response = await fetch('/api/auth/user');
                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;
                    
                    console.log('User data received:', user);
                    console.log('Profile picture URL:', user.picture);
                    
                    // Store user data
                    localStorage.setItem('propellerCurrentUser', JSON.stringify(user));
                    
                    // Update UI with user info
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('welcomeMessage').textContent = `Hi ${user.name.split(' ')[0]}!`;
                    
                    // Update account section
                    const userProfilePic = document.getElementById('userProfilePic');
                    const userEmailEl = document.getElementById('userEmail');
                    
                    if (userProfilePic && user.picture) {
                        userProfilePic.src = user.picture;
                        userProfilePic.alt = user.name;
                    } else if (userProfilePic) {
                        // Use a default avatar or initials
                        userProfilePic.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=10b981&color=fff&size=128`;
                    }
                    
                    if (userEmailEl && user.email) {
                        userEmailEl.textContent = user.email;
                    }
                    
                    // Update profile picture or initial
                    const userInitialElement = document.getElementById('userInitial');
                    
                    if (user.picture) {
                        // Replace the gradient container with profile picture
                        const profileContainer = userInitialElement.parentElement;
                        console.log('Profile container before:', profileContainer.className);
                        profileContainer.className = 'w-10 h-10 rounded-full flex items-center justify-center ring-2 ring-indigo-500/30 overflow-hidden bg-gray-800';
                        console.log('Profile container after:', profileContainer.className);
                        profileContainer.innerHTML = `<img src="${user.picture}" alt="${user.name}" class="w-full h-full object-cover" onload="console.log('Image loaded successfully')" onerror="console.error('Image failed to load'); this.style.display='none'; this.parentElement.innerHTML='<span class=\\'text-white text-sm font-bold\\'>${user.name.charAt(0).toUpperCase()}</span>';">`;
                        console.log('Profile container HTML updated');
                    } else {
                        // Use initial if no picture
                        userInitialElement.textContent = user.name.charAt(0).toUpperCase();
                    }
                } else {
                    // Not logged in, redirect to auth
                    window.location.href = '/auth';
                }
            } catch (error) {
                console.error('Error fetching user:', error);
                // Use fallback data
                const currentUser = JSON.parse(localStorage.getItem('propellerCurrentUser') || '{"name": "User", "email": "user@example.com"}');
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('welcomeMessage').textContent = `Hi ${currentUser.name}!`;
            }
        }
        
        // Initialize user on page load
        initializeUser();
        
        // Load chat history on page load
        loadChatHistory();
        
        // Populate sidebar avatar list
        async function populateSidebarAvatarList() {
            const list = document.getElementById('avatarsListSidebar');
            if (!list) return;
            
            list.innerHTML = '';
            
            const avatarDefinitions = {
                fitness: { name: 'Fitness Coach', image: 'assets/images/fitness.jpg' },
                tutor: { name: 'Personal Tutor', image: 'assets/images/tutor.png' },
                career: { name: 'Career Coach', image: 'assets/images/career.png' },
                finance: { name: 'Finance Advisor', image: 'assets/images/finance.png' },
                chef: { name: 'Personal Chef', image: 'assets/images/chef.png' }
            };
            
            for (const [key, data] of Object.entries(avatarDefinitions)) {
                try {
                    const res = await fetch(`/api/avatar/${key}/status`);
                    const status = await res.json();
                    
                    const div = document.createElement('div');
                    
                    if (status.hasQuestionnaire) {
                        // Avatar is set up - clickable to chat
                        div.innerHTML = `
                            <a href="/avatar-chat?avatar=${key}" class="avatar-item-new">
                                <img src="${data.image}" alt="${data.name}" class="avatar-icon-new">
                                <div class="avatar-info-new">
                                    <div class="avatar-name-new">${data.name}</div>
                                    <div class="avatar-status-new active"> Active</div>
                                </div>
                            </a>
                        `;
                    } else {
                        // Avatar needs setup - link to questionnaire
                        div.innerHTML = `
                            <a href="/questionnaire?avatar=${key}" class="avatar-item-new">
                                <img src="${data.image}" alt="${data.name}" class="avatar-icon-new" style="opacity: 0.5;">
                                <div class="avatar-info-new">
                                    <div class="avatar-name-new">${data.name}</div>
                                    <div class="avatar-status-new pending"> Setup needed</div>
                                </div>
                            </a>
                        `;
                    }
                    
                    list.appendChild(div);
                } catch (err) {
                    console.error('Error fetching avatar status:', err);
                }
            }
        }
        
        // Initialize sidebar avatar list
        populateSidebarAvatarList();

        // Dropdown toggle functionality
        const avatarsDropdownHeader = document.getElementById('avatarsDropdownHeader');
        const historyDropdownHeader = document.getElementById('historyDropdownHeader');
        
        if (avatarsDropdownHeader) {
            avatarsDropdownHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                const content = this.nextElementSibling;
                const arrow = this.querySelector('.dropdown-arrow');
                
                // Close other dropdowns
                if (historyDropdownHeader) {
                    const historyContent = historyDropdownHeader.nextElementSibling;
                    const historyArrow = historyDropdownHeader.querySelector('.dropdown-arrow');
                    historyContent.classList.remove('expanded');
                    historyArrow.style.transform = 'rotate(0deg)';
                }
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('expanded');
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
        }
        
        if (historyDropdownHeader) {
            historyDropdownHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                const content = this.nextElementSibling;
                const arrow = this.querySelector('.dropdown-arrow');
                
                // Close other dropdowns
                if (avatarsDropdownHeader) {
                    const avatarsContent = avatarsDropdownHeader.nextElementSibling;
                    const avatarsArrow = avatarsDropdownHeader.querySelector('.dropdown-arrow');
                    avatarsContent.classList.remove('expanded');
                    avatarsArrow.style.transform = 'rotate(0deg)';
                }
                
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    content.classList.add('expanded');
                    arrow.style.transform = 'rotate(180deg)';
                }
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const isClickInsideSidebar = e.target.closest('#sidebar');
            
            if (!isClickInsideSidebar) {
                // Close all dropdowns
                if (avatarsDropdownHeader) {
                    const content = avatarsDropdownHeader.nextElementSibling;
                    const arrow = avatarsDropdownHeader.querySelector('.dropdown-arrow');
                    content.classList.remove('expanded');
                    arrow.style.transform = 'rotate(0deg)';
                }
                
                if (historyDropdownHeader) {
                    const content = historyDropdownHeader.nextElementSibling;
                    const arrow = historyDropdownHeader.querySelector('.dropdown-arrow');
                    content.classList.remove('expanded');
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        });

        // Variables
        let hasMessages = false;
        let conversationHistory = [];
        let currentChatId = Date.now().toString();
        let uploadedAttachments = [];
        
        console.log('=== CHAT SCRIPT INITIALIZING ===');
        
        // Helper function to format time
        function formatTime(date) {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const displayMinutes = minutes < 10 ? '0' + minutes : minutes;
            return `${displayHours}:${displayMinutes} ${ampm}`;
        }
        
        // Elements - Get references immediately
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const messagesList = document.getElementById('messagesList');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const newChatBtn = document.getElementById('newChatBtn');
        const messageInputBottom = document.getElementById('messageInputBottom');
        const sendBtnBottom = document.getElementById('sendBtnBottom');
        
        console.log('Elements loaded:', {
            messageInput: !!messageInput,
            sendBtn: !!sendBtn,
            messagesContainer: !!messagesContainer,
            messagesList: !!messagesList
        });
        
        // SIMPLE SEND MESSAGE FUNCTION
        function sendMessage() {
            console.log('>>> sendMessage() called');
            
            // Get the active input
            const activeInput = hasMessages ? messageInputBottom : messageInput;
            const message = activeInput.value.trim();
            
            console.log('Message text:', message);
            console.log('Message length:', message.length);
            
            // Validate message
            if (!message) {
                console.log('Empty message, returning');
                showToast('Please enter a message', 'warning');
                return;
            }
            
            console.log('>>> Message is valid, proceeding...');
            
            // Show messages area if first message
            if (!hasMessages) {
                console.log('First message - showing chat area');
                hasMessages = true;
                welcomeScreen.classList.add('hidden');
                messagesContainer.classList.remove('hidden');
                document.getElementById('bottomInputArea').classList.remove('hidden');
            }
            
            // Get current timestamp
            const timestamp = new Date();
            
            // Create user message bubble with timestamp
            console.log('Creating user message element');
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'flex justify-end message-fade-in';
            userMsgDiv.innerHTML = `
                <div class="flex flex-col items-end">
                    <div class="chat-bubble px-5 py-3 rounded-2xl shadow-lg bg-gradient-to-r from-indigo-600 to-indigo-500 text-white max-w-3xl">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 px-1">${formatTime(timestamp)}</div>
                </div>
            `;
            
            messagesList.appendChild(userMsgDiv);
            console.log('User message added to DOM');
            
            // Clear input
            activeInput.value = '';
            // Reset textarea height
            activeInput.style.height = '44px';
            console.log('Input cleared and height reset');
            
            // Scroll to bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                console.log('Scrolled to bottom');
            }, 100);
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            addTypingIndicator();
            
            // Send to backend (simplified for now)
            sendToBackend(message);
            
            showToast('Message sent!', 'success');
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex justify-start message-fade-in';
            typingDiv.innerHTML = `
                <div class="flex flex-col items-start">
                    <div class="px-5 py-3 rounded-2xl shadow-lg border glass-effect" style="border-color: rgba(255, 255, 255, 0.08);">
                        <div class="flex items-center space-x-3">
                            <div class="flex space-x-1.5">
                                <div class="w-2 h-2 bg-indigo-500 rounded-full typing-dot"></div>
                                <div class="w-2 h-2 bg-purple-500 rounded-full typing-dot" style="animation-delay: 0.2s"></div>
                                <div class="w-2 h-2 bg-pink-500 rounded-full typing-dot" style="animation-delay: 0.4s"></div>
                            </div>
                            <span class="text-gray-400 text-sm">Propeller is thinking...</span>
                        </div>
                    </div>
                </div>
            `;
            messagesList.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }
        
        // Send to backend
        async function sendToBackend(message) {
            try {
                const response = await fetch(`/api/chats/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        conversationHistory: conversationHistory.slice(0, -1),
                        language: 'en'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API error');
                }
                
                removeTypingIndicator();
                
                // Get timestamp for bot message
                const botTimestamp = new Date();
                
                // Create bot message container
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'flex justify-start message-fade-in';
                botMessageDiv.innerHTML = `
                    <div class="flex flex-col items-start">
                        <div class="chat-bubble px-5 py-3 rounded-2xl shadow-lg border glass-effect text-gray-100 max-w-3xl" style="border-color: rgba(255, 255, 255, 0.08);">
                            <div class="bot-message-content"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 px-1">${formatTime(botTimestamp)}</div>
                    </div>
                `;
                messagesList.appendChild(botMessageDiv);
                
                const contentDiv = botMessageDiv.querySelector('.bot-message-content');
                let fullResponse = '';
                
                // Stream response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content) {
                                    fullResponse += parsed.content;
                                    contentDiv.textContent = fullResponse;
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }
                
                conversationHistory.push({ role: 'assistant', content: fullResponse });
                
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                
                // Show user-friendly error message
                const errorMsgDiv = document.createElement('div');
                errorMsgDiv.className = 'flex justify-start message-fade-in';
                errorMsgDiv.innerHTML = `
                    <div class="flex flex-col items-start">
                        <div class="chat-bubble px-5 py-3 rounded-2xl shadow-lg border border-red-500/30 glass-effect text-red-300 max-w-3xl">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="font-semibold">Connection Error</span>
                            </div>
                            <p class="text-sm">Sorry, I couldn't process your message. Please check your connection and try again.</p>
                        </div>
                        <div class="text-xs text-gray-500 mt-1 px-1">${formatTime(new Date())}</div>
                    </div>
                `;
                messagesList.appendChild(errorMsgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                showToast('Failed to send message. Please try again.', 'error');
            }
        }
        
        // ===== EVENT LISTENERS =====
        console.log('=== Setting up event listeners ===');
        
        // Main send button
        if (sendBtn) {
            sendBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('>>> Send button CLICKED');
                sendMessage();
            });
            console.log(' Send button listener added');
        }
        
        // Main input Enter key and auto-resize
        if (messageInput) {
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('>>> Enter key PRESSED in main input');
                    sendMessage();
                }
            });
            
            // Auto-resize as user types
            messageInput.addEventListener('input', function() {
                this.style.height = '44px'; // Reset to min height
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
            
            console.log(' Main input keydown listener added');
        }
        
        // Bottom send button
        if (sendBtnBottom) {
            sendBtnBottom.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('>>> Bottom send button CLICKED');
                sendMessage();
            });
            console.log(' Bottom send button listener added');
        }
        
        // Bottom input Enter key and auto-resize
        if (messageInputBottom) {
            messageInputBottom.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('>>> Enter key PRESSED in bottom input');
                    sendMessage();
                }
            });
            
            // Auto-resize as user types
            messageInputBottom.addEventListener('input', function() {
                this.style.height = '44px'; // Reset to min height
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
            
            console.log(' Bottom input keydown listener added');
        }
        
        console.log('=== Event listeners setup complete ===');
        
        // ===== OTHER UI FUNCTIONALITY =====
        
        // Get other essential elements
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutBtnAccount = document.getElementById('logoutBtnAccount');
        const sidebar = document.getElementById('sidebar');
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        
        // New chat button
        if (newChatBtn) {
            newChatBtn.addEventListener('click', () => {
                console.log('New chat clicked');
                hasMessages = false;
                conversationHistory = [];
                currentChatId = Date.now().toString();
                messagesList.innerHTML = '';
                messagesContainer.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                document.getElementById('bottomInputArea').classList.add('hidden');
                messageInput.value = '';
                if (messageInputBottom) messageInputBottom.value = '';
            });
        }
        
        // Logout functionality
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                } catch (error) {
                    console.error('Logout error:', error);
                }
                localStorage.removeItem('propellerCurrentUser');
                window.location.href = '/auth';
            });
        }
        
        if (logoutBtnAccount) {
            logoutBtnAccount.addEventListener('click', async () => {
                try {
                    await fetch('/api/auth/logout', { method: 'POST' });
                } catch (error) {
                    console.error('Logout error:', error);
                }
                localStorage.removeItem('propellerCurrentUser');
                window.location.href = '/auth';
            });
        }
        
        // Mobile sidebar toggle
        if (mobileSidebarToggle && sidebar) {
            mobileSidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });
        }
        
        // Account dropdown
        const accountTrigger = document.getElementById('accountTrigger');
        const accountDropdown = document.getElementById('accountDropdown');
        
        if (accountTrigger && accountDropdown) {
            accountTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                accountDropdown.classList.toggle('hidden');
            });
            
            document.addEventListener('click', () => {
                if (accountDropdown) {
                    accountDropdown.classList.add('hidden');
                }
            });
            
            accountDropdown.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Focus input on load
        if (messageInput) {
            messageInput.focus();
        }
        
        console.log('=== Chat system initialized and ready ===');
        
        // ===== INITIALIZE USER AND LOAD DATA =====
        newChatBtn.addEventListener('click', () => {
            hasMessages = false;
            conversationHistory = [];
            currentChatId = Date.now().toString();
            messagesList.innerHTML = '';
            messagesContainer.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            document.getElementById('bottomInputArea').classList.add('hidden');
            messageInput.value = '';
            messageInput.style.height = '44px'; // Reset height
            if (messageInputBottom) {
                messageInputBottom.value = '';
                messageInputBottom.style.height = '44px'; // Reset height
            }
            renderChatHistory(); // Update UI to remove active state
        });
        
        // Suggestion cards
        const suggestionCards = document.querySelectorAll('.suggestion-card');
        suggestionCards.forEach(card => {
            card.addEventListener('click', () => {
                const promptText = card.getAttribute('data-prompt');
                messageInput.value = promptText;
                messageInput.focus();
            });
        });
        
        // File upload button
        document.getElementById('fileUploadBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                
                try {
                    // Show uploading indicator
                    const uploadIndicator = document.createElement('div');
                    uploadIndicator.className = 'text-indigo-400 text-sm mb-2';
                    uploadIndicator.textContent = `Uploading ${files.length} file(s)...`;
                    messageInput.parentElement.insertBefore(uploadIndicator, messageInput);
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Remove upload indicator
                    uploadIndicator.remove();
                    
                    if (response.ok) {
                        const data = await response.json();
                        uploadedAttachments = uploadedAttachments.concat(data.files);
                        
                        // Show uploaded files
                        displayUploadedFiles();
                    } else if (response.status === 429) {
                        // Upload limit reached
                        const errorData = await response.json();
                        showToast(errorData.message || 'Upload limit reached. Please try again later.', 'error');
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('File upload error:', error);
                    showToast('Failed to upload files. Please try again.', 'error');
                }
                
                // Clear file input
                e.target.value = '';
            }
        });
        
        function displayUploadedFiles() {
            let attachmentsContainer = document.getElementById('attachmentsContainer');
            if (!attachmentsContainer) {
                attachmentsContainer = document.createElement('div');
                attachmentsContainer.id = 'attachmentsContainer';
                attachmentsContainer.className = 'flex flex-wrap gap-2 mb-2 px-2';
                messageInput.parentElement.insertBefore(attachmentsContainer, messageInput);
            }
            
            attachmentsContainer.innerHTML = uploadedAttachments.map((file, index) => `
                <div class="flex items-center gap-2 bg-gray-800 rounded-lg px-3 py-2 text-sm">
                    ${file.mimetype.startsWith('image/') ? 
                        `<img src="${file.url}" class="w-8 h-8 rounded object-cover">` :
                        `<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>`
                    }
                    <span class="text-gray-300">${file.originalname}</span>
                    <button onclick="removeAttachment(${index})" class="text-red-400 hover:text-red-300 ml-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }
        
        function removeAttachment(index) {
            uploadedAttachments.splice(index, 1);
            if (uploadedAttachments.length === 0) {
                const container = document.getElementById('attachmentsContainer');
                if (container) container.remove();
            } else {
                displayUploadedFiles();
            }
        }
        
        // Focus input on load
        messageInput.focus();
        
        // Chat history management
        let chatHistory = [];
        let selectedPersonality = null;
        
        // Personality definitions with system prompts
        const personalities = {
            fitness: {
                name: 'Fitness Coach',
                systemPrompt: 'You are an experienced fitness coach and personal trainer. You provide workout advice, nutrition guidance, exercise form corrections, and motivation. Ask about fitness goals, current fitness level, any injuries or limitations, and preferred workout style. Keep responses practical and encouraging.',
                icon: 'lightning',
                color: 'bg-gray-700'
            },
            tutor: {
                name: 'Personal Tutor',
                systemPrompt: 'You are a knowledgeable and patient tutor who helps students learn various subjects. Ask about what subject they need help with, their current understanding level, learning goals, and preferred learning style. Break down complex topics into understandable parts and provide examples.',
                icon: 'book',
                color: 'bg-gray-700'
            },
            career: {
                name: 'Career Coach',
                systemPrompt: 'You are a professional career coach with expertise in career development, job searching, and professional growth. Ask about their current career situation, goals, skills, interests, and challenges. Provide actionable advice on career planning, resume building, interview preparation, and professional development.',
                icon: 'briefcase',
                color: 'bg-gray-700'
            },
            finance: {
                name: 'Finance Advisor',
                systemPrompt: 'You are a knowledgeable financial advisor who helps with personal finance, budgeting, investing, and financial planning. Ask about their financial goals, current financial situation, risk tolerance, and time horizon. Provide practical advice on budgeting, saving, investing, and debt management. Always remind users to consult with licensed professionals for specific financial decisions.',
                icon: 'currency',
                color: 'bg-gray-700'
            },
            chef: {
                name: 'Personal Chef',
                systemPrompt: 'You are an experienced personal chef and culinary expert. Help with meal planning, recipes, cooking techniques, dietary requirements, and food preparation. Ask about dietary restrictions, cooking skill level, available ingredients, time constraints, and cuisine preferences. Provide clear, detailed cooking instructions.',
                icon: 'plus',
                color: 'bg-gray-700'
            }
        };
        
        // Handle personality selection
        document.querySelectorAll('.personality-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const personalityType = this.getAttribute('data-personality');
                selectPersonality(personalityType);
            });
        });
        
        function selectPersonality(type) {
            selectedPersonality = type;
            
            // Update UI - highlight selected personality
            document.querySelectorAll('.personality-btn').forEach(btn => {
                if (btn.getAttribute('data-personality') === type) {
                    btn.classList.add('bg-indigo-600/30', 'border-l-3', 'border-indigo-500');
                    btn.classList.remove('text-gray-300');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('bg-indigo-600/30', 'border-l-3', 'border-indigo-500');
                    btn.classList.add('text-gray-300');
                    btn.classList.remove('text-white');
                }
            });
            
            // Start new chat with personality
            startNewChat();
            
            // Show personality indicator in welcome message
            const personality = personalities[type];
            document.getElementById('welcomeMessage').textContent = `Chat with ${personality.name}`;
            
            showToast(`Switched to ${personality.name} mode`, 'success');
        }

        async function loadChatHistory() {
            try {
                const response = await fetch('/api/chats');
                if (response.ok) {
                    const data = await response.json();
                    // Server returns array directly, not wrapped in object
                    chatHistory = Array.isArray(data) ? data : (data.chats || []);
                    // Sort by most recent first (in case server doesn't sort)
                    chatHistory.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    renderChatHistory();
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        function renderChatHistory() {
            const chatHistoryList = document.getElementById('chatHistoryList');
            const noChatHistory = document.getElementById('noChatHistory');
            
            if (chatHistory.length === 0) {
                noChatHistory.style.display = 'block';
                chatHistoryList.innerHTML = '';
                return;
            }
            
            noChatHistory.style.display = 'none';
            
            // Render chats in LLM style (most recent first)
            let html = '';
            chatHistory.forEach(chat => {
                const isActive = currentChatId === chat.id;
                html += `
                <div class="llm-chat-item ${isActive ? 'active' : ''}" data-chat-id="${chat.id}">
                    <svg class="llm-chat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="llm-chat-title">${chat.title}</span>
                    <div class="llm-chat-actions">
                        <button class="llm-chat-action-btn rename" onclick="event.stopPropagation(); renameChat('${chat.id}')" title="Rename chat">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button class="llm-chat-action-btn delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')" title="Delete chat">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            });
            
            chatHistoryList.innerHTML = html;
            
            // Add click handlers for chat items
            document.querySelectorAll('.llm-chat-item').forEach((item) => {
                item.addEventListener('click', async (e) => {
                    // Don't load chat if clicking on action buttons
                    if (e.target.closest('.llm-chat-action-btn')) {
                        return;
                    }
                    const chatId = item.dataset.chatId;
                    await loadChat(chatId);
                });
            });
        }

        async function loadChat(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}`);
                if (response.ok) {
                    const data = await response.json();
                    const chat = data.chat;
                    
                    // Set current chat
                    currentChatId = chatId;
                    conversationHistory = [...chat.messages]; // Create a copy
                    
                    // Clear and load messages
                    messagesList.innerHTML = '';
                    hasMessages = false;
                    
                    if (chat.messages.length > 0) {
                        hasMessages = true;
                        welcomeScreen.classList.add('hidden');
                        messagesContainer.classList.remove('hidden');
                        document.getElementById('bottomInputArea').classList.remove('hidden');
                        
                        chat.messages.forEach(msg => {
                            addMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', false, msg.attachments || []);
                        });
                    } else {
                        // Empty chat
                        welcomeScreen.classList.remove('hidden');
                        messagesContainer.classList.add('hidden');
                        document.getElementById('bottomInputArea').classList.add('hidden');
                    }
                    
                    // Update UI
                    renderChatHistory();
                    
                    // Focus on input
                    messageInput.focus();
                } else {
                    console.error('Failed to load chat:', response.status);
                }
            } catch (error) {
                console.error('Error loading chat:', error);
                alert('Failed to load chat. Please try again.');
            }
        }

        function toggleChatMenu(event, chatId) {
            event.stopPropagation();
            const menu = document.getElementById(`chatMenu${chatId}`);
            
            // Close all other menus
            document.querySelectorAll('[id^="chatMenu"]').forEach(m => {
                if (m.id !== `chatMenu${chatId}`) {
                    m.classList.add('hidden');
                }
            });
            
            menu.classList.toggle('hidden');
        }

        let currentRenameChatId = null;
        let currentDeleteChatId = null;

        function renameChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            currentRenameChatId = chatId;
            document.getElementById('renameChatInput').value = chat.title;
            document.getElementById('renameModal').classList.remove('hidden');
            document.getElementById(`chatMenu${chatId}`).classList.add('hidden');
            // Focus input after animation
            setTimeout(() => {
                document.getElementById('renameChatInput').focus();
                document.getElementById('renameChatInput').select();
            }, 100);
        }

        function closeRenameModal() {
            document.getElementById('renameModal').classList.add('hidden');
            currentRenameChatId = null;
        }

        async function confirmRename() {
            const newTitle = document.getElementById('renameChatInput').value.trim();
            if (newTitle && currentRenameChatId) {
                try {
                    const response = await fetch(`/api/chats/${currentRenameChatId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title: newTitle })
                    });
                    if (response.ok) {
                        await loadChatHistory();
                        closeRenameModal();
                    }
                } catch (error) {
                    console.error('Error renaming chat:', error);
                    alert('Failed to rename chat. Please try again.');
                }
            }
        }

        function deleteChat(chatId) {
            currentDeleteChatId = chatId;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById(`chatMenu${chatId}`).classList.add('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            currentDeleteChatId = null;
        }

        async function confirmDelete() {
            if (currentDeleteChatId) {
                try {
                    const response = await fetch(`/api/chats/${currentDeleteChatId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        if (currentChatId === currentDeleteChatId) {
                            // If deleting current chat, start new chat
                            newChatBtn.click();
                        }
                        await loadChatHistory();
                        closeDeleteModal();
                    }
                } catch (error) {
                    console.error('Error deleting chat:', error);
                    alert('Failed to delete chat. Please try again.');
                }
            }
        }

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeRenameModal();
                closeDeleteModal();
            }
        });

        // Close modals on Enter key for rename
        document.getElementById('renameChatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmRename();
            }
        });

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-menu-btn')) {
                document.querySelectorAll('[id^="chatMenu"]').forEach(m => {
                    m.classList.add('hidden');
                });
            }
        });

        // Check for avatar parameter in URL
        function checkAvatarParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const avatarParam = urlParams.get('avatar');
            
            if (avatarParam && personalities[avatarParam]) {
                // Automatically select the personality
                selectPersonality(avatarParam);
                
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Initial render
        renderChatHistory();
        checkAvatarParam();
    </script>

    <!-- Rename Chat Modal -->
    <div id="renameModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl border border-gray-800 max-w-md w-full transform transition-all" style="animation: modalSlideIn 0.2s ease-out;">
            <div class="p-6 border-b border-gray-800">
                <h3 class="text-xl font-bold text-white flex items-center gap-3">
                    <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Rename Chat
                </h3>
            </div>
            <div class="p-6">
                <input type="text" id="renameChatInput" placeholder="Enter new chat name..." class="w-full px-4 py-3 bg-gray-800 text-white rounded-xl border border-gray-700 focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 transition-all">
            </div>
            <div class="p-6 pt-0 flex gap-3">
                <button onclick="closeRenameModal()" class="flex-1 px-4 py-3 bg-gray-800 text-gray-300 rounded-xl hover:bg-gray-700 transition-all font-medium">
                    Cancel
                </button>
                <button onclick="confirmRename()" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-all font-medium shadow-lg">
                    Rename
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Chat Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl shadow-2xl border border-gray-800 max-w-md w-full transform transition-all" style="animation: modalSlideIn 0.2s ease-out;">
            <div class="p-6 border-b border-gray-800">
                <h3 class="text-xl font-bold text-white flex items-center gap-3">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete Chat
                </h3>
            </div>
            <div class="p-6">
                <p class="text-gray-300">Are you sure you want to delete this chat? This action cannot be undone.</p>
            </div>
            <div class="p-6 pt-0 flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 px-4 py-3 bg-gray-800 text-gray-300 rounded-xl hover:bg-gray-700 transition-all font-medium">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all font-medium shadow-lg">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</body>
</html>
<script>
// Avatar switcher for main chat
const avatarSwitcherMain = document.getElementById('avatarSwitcherMain');
const avatarSwitcherDropdownMain = document.getElementById('avatarSwitcherDropdownMain');

const avatars = {
  fitness: { name: 'Fitness Coach', image: 'assets/images/fitness.jpg' },
  tutor: { name: 'Personal Tutor', image: 'assets/images/tutor.png' },
  career: { name: 'Career Coach', image: 'assets/images/career.png' },
  finance: { name: 'Finance Advisor', image: 'assets/images/finance.png' },
  chef: { name: 'Personal Chef', image: 'assets/images/chef.png' }
};

avatarSwitcherMain.addEventListener('click', (e) => {
  e.stopPropagation();
  avatarSwitcherDropdownMain.classList.toggle('hidden');
});

document.addEventListener('click', () => {
  avatarSwitcherDropdownMain.classList.add('hidden');
});

avatarSwitcherDropdownMain.addEventListener('click', (e) => e.stopPropagation());

async function populateAvatarListMain() {
  const list = document.getElementById('avatarListMain');
  list.innerHTML = '';
  for (const [key, data] of Object.entries(avatars)) {
    try {
      const res = await fetch(`/api/avatar/${key}/status`);
      const status = await res.json();
      const div = document.createElement('div');
      if (status.hasQuestionnaire) {
        div.innerHTML = `
          <a href="/avatar-chat?avatar=${key}" class="flex items-center space-x-3 p-4 hover:bg-indigo-600/20 transition-colors border-b" style="border-color: #3a3a3c;">
            <img src="${data.image}" alt="${data.name}" class="w-10 h-10 rounded-xl">
            <div class="flex-1">
              <div class="text-white font-semibold">${data.name}</div>
              <div class="text-xs text-green-400">Ready</div>
            </div>
          </a>
        `;
      } else {
        div.innerHTML = `
          <a href="/questionnaire?avatar=${key}" class="flex items-center space-x-3 p-4 hover:bg-yellow-600/20 transition-colors border-b" style="border-color: #3a3a3c;">
            <img src="${data.image}" alt="${data.name}" class="w-10 h-10 rounded-xl opacity-50">
            <div class="flex-1">
              <div class="text-white font-semibold">${data.name}</div>
              <div class="text-xs text-yellow-400">Setup Required</div>
            </div>
          </a>
        `;
      }
      list.appendChild(div);
    } catch (err) {
      console.error('Error fetching avatar status', err);
    }
  }
}

populateAvatarListMain();
</script>
